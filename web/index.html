<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydrogen Policy Library</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] {
            display: none !important;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body class="bg-gray-100 h-screen flex flex-col overflow-hidden" x-data="library()">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-3 flex justify-between items-center shadow-sm z-10">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">H2</div>
            <h1 class="font-semibold text-gray-800 text-lg">Hydrogen Policy Library</h1>
        </div>
        <div class="text-sm text-gray-500">
            <span x-text="filteredPolicies.length"></span> Documents Found
        </div>
    </header>

    <!-- Main Content (Mailbox Layout) -->
    <div class="flex-1 flex overflow-hidden">

        <!-- SIDEBAR: List & Search -->
        <div class="w-1/3 min-w-[350px] max-w-[500px] bg-white border-r border-gray-200 flex flex-col z-0">
            <!-- Search & Filter -->
            <div class="p-4 border-b border-gray-100 space-y-3 bg-gray-50">
                <input type="text" x-model="search" placeholder="Search titles or content..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                <div class="flex gap-2">
                    <select x-model="filterProv"
                        class="flex-1 px-3 py-1.5 bg-white border border-gray-300 rounded text-sm text-gray-600">
                        <option value="">All Provinces</option>
                        <template x-for="p in meta.provinces">
                            <option :value="p" x-text="p"></option>
                        </template>
                    </select>
                    <select x-model="filterYear"
                        class="w-24 px-3 py-1.5 bg-white border border-gray-300 rounded text-sm text-gray-600">
                        <option value="">Year</option>
                        <template x-for="y in meta.years">
                            <option :value="y" x-text="y"></option>
                        </template>
                    </select>
                </div>
                <!-- Checkbox -->
                <div class="flex items-center gap-2 mt-2">
                    <input type="checkbox" id="hideEmpty" x-model="hideEmpty"
                        class="rounded text-blue-600 focus:ring-blue-500">
                    <label for="hideEmpty" class="text-xs text-gray-600 cursor-pointer select-none">Show only entries
                        with AI analysis</label>
                </div>
            </div>

            <!-- List -->
            <div class="flex-1 overflow-y-auto p-2 space-y-2">
                <template x-for="doc in filteredPolicies" :key="doc.id">
                    <div @click="selectDoc(doc)"
                        :class="selected && selected.id === doc.id ? 'bg-blue-50 border-blue-200 ring-1 ring-blue-300' : 'bg-white border-gray-100 hover:bg-gray-50 hover:border-gray-300'"
                        class="p-4 rounded-lg border cursor-pointer transition-all duration-200 shadow-sm">
                        <div class="flex justify-between items-start mb-1">
                            <span
                                class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600 truncate max-w-[120px]"
                                x-text="doc.province"></span>
                            <span class="text-xs text-gray-400 font-mono" x-text="doc.year || 'N/A'"></span>
                        </div>
                        <h3 class="text-sm font-semibold text-gray-900 leading-tight mb-2" x-text="doc.title"></h3>
                        <!-- Tags -->
                        <div class="flex flex-wrap gap-1">
                            <template x-for="tag in doc.instrument_tags.slice(0, 3)">
                                <span class="text-[10px] px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded"
                                    x-text="tag.split('_').pop().replace('subsidy','Subsidy')"></span>
                            </template>
                        </div>
                    </div>
                </template>
                <div x-show="filteredPolicies.length === 0" class="p-8 text-center text-gray-400 text-sm">
                    No documents match your search.
                </div>
            </div>
        </div>

        <!-- MAIN: Detail Reader -->
        <main class="flex-1 bg-gray-50 flex flex-col relative">
            <template x-if="!selected">
                <div class="flex-1 flex flex-col items-center justify-center text-gray-400">
                    <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z">
                        </path>
                    </svg>
                    <p class="text-lg font-medium">Select a policy to analyze</p>
                </div>
            </template>

            <template x-if="selected">
                <div class="flex-1 flex flex-col h-full">
                    <!-- Detail Header -->
                    <div class="bg-white border-b border-gray-200 p-6">
                        <div class="flex items-center gap-3 text-sm text-gray-500 mb-2">
                            <span class="font-mono bg-gray-100 px-2 py-1 rounded" x-text="selected.id"></span>
                            <span>&bull;</span>
                            <span x-text="selected.province"></span>
                            <span>&bull;</span>
                            <span x-text="selected.year || 'Year Unknown'"></span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 leading-snug" x-text="selected.title"></h2>
                    </div>

                    <!-- Tabs -->
                    <div class="flex border-b border-gray-200 bg-white px-6">
                        <button @click="tab = 'analysis'"
                            :class="tab === 'analysis' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="px-4 py-3 text-sm font-medium border-b-2 transition-colors">Analysis &
                            Insights</button>
                        <button @click="tab = 'text'"
                            :class="tab === 'text' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="px-4 py-3 text-sm font-medium border-b-2 transition-colors">Full Text
                            Content</button>
                    </div>

                    <!-- Content Area -->
                    <div class="flex-1 overflow-y-auto p-8 custom-scroller">

                        <!-- VIEW: Analysis -->
                        <div x-show="tab === 'analysis'" class="space-y-8 max-w-4xl mx-auto">

                            <!-- New: Empty State for Analysis -->
                            <div x-show="!selected.has_data"
                                class="bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg flex items-start gap-3">
                                <svg class="w-5 h-5 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <p class="font-semibold">No Specific Economic Data Found</p>
                                    <p class="text-sm mt-1">The AI analysis did not identify specific targets,
                                        subsidies, or tax incentives in this document. It may be a general guideline or
                                        administrative notice.</p>
                                    <button @click="tab = 'text'" class="text-sm underline mt-2 font-medium">Read Full
                                        Text Instead &rarr;</button>
                                </div>
                            </div>

                            <!-- Analysis Cards -->
                            <!-- Analysis Cards (Full Width for Readability) -->
                            <div x-show="selected.has_data" class="space-y-6">

                                <!-- Targets -->
                                <div x-show="Object.keys(selected.analysis.targets).length > 0"
                                    class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                                    <h3 class="text-gray-900 font-semibold mb-4 flex items-center gap-2 text-lg">
                                        <span>üìà</span> Quantitative Targets
                                    </h3>
                                    <div class="space-y-4">
                                        <template x-for="(val, key) in selected.analysis.targets">
                                            <div x-show="val" class="text-sm">
                                                <div class="flex justify-between items-baseline mb-1">
                                                    <span class="text-gray-600 font-medium capitalize"
                                                        x-text="key.replace('target_', '').replace(/_/g, ' ')"></span>
                                                    <span
                                                        class="font-mono font-bold text-gray-900 bg-gray-100 px-2 rounded"
                                                        x-text="val.value"></span>
                                                </div>
                                                <div x-show="val.evidence"
                                                    class="mt-2 text-gray-600 bg-gray-50 p-3 rounded border-l-4 border-blue-400">
                                                    "<span x-text="val.evidence"></span>"
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- Funding & Finance -->
                                <div x-show="Object.keys({...selected.analysis.subsidies, ...selected.analysis.taxes}).length > 0"
                                    class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                                    <h3 class="text-gray-900 font-semibold mb-4 flex items-center gap-2 text-lg">
                                        <span>üí∞</span> Incentives & Finance
                                    </h3>
                                    <div class="grid grid-cols-1 gap-6">
                                        <template
                                            x-for="(val, key) in {...selected.analysis.subsidies, ...selected.analysis.taxes}">
                                            <div x-show="val && (val.value || val.evidence)"
                                                class="text-sm border-b border-gray-100 last:border-0 pb-4 last:pb-0">
                                                <div class="font-bold text-gray-800 mb-1 capitalize text-base"
                                                    x-text="key.replace('fiscal_', '').replace('tax_', '').replace(/_/g, ' ')">
                                                </div>
                                                <div class="mb-2 text-gray-700"
                                                    x-text="val.value || 'Policy Support Mentioned'"></div>
                                                <div x-show="val.evidence"
                                                    class="text-gray-600 bg-emerald-50 p-3 rounded border-l-4 border-emerald-400 font-serif">
                                                    "<span x-text="val.evidence"></span>"
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- R&D and Innovation -->
                                <div x-show="Object.keys(selected.analysis.rd).length > 0"
                                    class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                                    <h3 class="text-gray-900 font-semibold mb-4 flex items-center gap-2 text-lg">
                                        <span>üî¨</span> R&D & Innovation
                                    </h3>
                                    <div class="space-y-6">
                                        <template x-for="(val, key) in selected.analysis.rd">
                                            <div x-show="val" class="text-sm">
                                                <div class="font-bold text-gray-800 mb-1 capitalize text-base"
                                                    x-text="key.replace(/_/g, ' ')"></div>
                                                <div class="mb-2 text-gray-700" x-text="val.value"></div>
                                                <div x-show="val.evidence"
                                                    class="text-gray-600 bg-purple-50 p-3 rounded border-l-4 border-purple-400 font-serif">
                                                    "<span x-text="val.evidence"></span>"
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- Standards & Factors -->
                                <div x-show="Object.keys({...selected.analysis.factors, ...selected.analysis.standards}).length > 0"
                                    class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                                    <h3 class="text-gray-900 font-semibold mb-4 flex items-center gap-2 text-lg">
                                        <span>‚öñÔ∏è</span> Standards & Factors
                                    </h3>
                                    <div class="space-y-6">
                                        <template
                                            x-for="(val, key) in {...selected.analysis.factors, ...selected.analysis.standards}">
                                            <div x-show="val" class="text-sm">
                                                <div class="font-bold text-gray-800 mb-1 capitalize text-base"
                                                    x-text="key.replace(/_/g, ' ')"></div>
                                                <div class="mb-2 text-gray-700" x-text="val.value"></div>
                                                <div x-show="val.evidence"
                                                    class="text-gray-600 bg-orange-50 p-3 rounded border-l-4 border-orange-400 font-serif">
                                                    "<span x-text="val.evidence"></span>"
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- Other Instruments -->
                                <div x-show="selected.analysis.other && selected.analysis.other.length > 0"
                                    class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                                    <h3 class="text-gray-900 font-semibold mb-4 flex items-center gap-2 text-lg">
                                        <span>üîß</span> Other Instruments
                                    </h3>
                                    <div class="space-y-4">
                                        <template x-for="inst in selected.analysis.other">
                                            <div class="bg-gray-50 p-4 rounded-lg">
                                                <div class="font-bold text-gray-900 mb-1" x-text="inst.name"></div>
                                                <div class="text-gray-700 text-sm mb-2" x-text="inst.description"></div>
                                                <div x-show="inst.evidence"
                                                    class="text-xs text-gray-500 italic border-t border-gray-200 pt-2 mt-2">
                                                    Evidence: "<span x-text="inst.evidence"></span>"
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>

                            <!-- Raw JSON Dump (for debug/trust) -->
                            <!-- Optional, maybe hidden or minimal -->
                        </div>

                        <!-- VIEW: Full Text -->
                        <div x-show="tab === 'text'"
                            class="max-w-4xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 p-8 min-h-[500px]">
                            <div class="prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap font-serif leading-relaxed"
                                x-text="selected.content"></div>
                        </div>

                    </div>
                </div>
            </template>
        </main>
    </div>

    <!-- Script -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('library', () => ({
                policies: [],
                filteredPolicies: [],
                meta: { provinces: [], years: [] },
                search: '',
                filterProv: '',
                filterYear: '',
                hideEmpty: true,
                selected: null,
                tab: 'analysis', // 'analysis' or 'text'

                async init() {
                    try {
                        const res = await fetch('data/data.json');
                        const data = await res.json();
                        this.policies = data.policies;
                        this.meta = data.meta;
                        this.updateFilter();
                    } catch (e) {
                        alert("Failed to load data. Ensure server is running.");
                    }

                    this.$watch('search', () => this.updateFilter());
                    this.$watch('filterProv', () => this.updateFilter());
                    this.$watch('filterYear', () => this.updateFilter());
                    this.$watch('hideEmpty', () => this.updateFilter());
                },

                updateFilter() {
                    const q = this.search.toLowerCase();
                    const p = this.filterProv;
                    const y = this.filterYear;
                    const hide = this.hideEmpty;

                    this.filteredPolicies = this.policies.filter(doc => {
                        // Text Search
                        const textMatch = !q || doc.title.toLowerCase().includes(q) || (doc.content && doc.content.toLowerCase().includes(q));
                        // Filters
                        const provMatch = !p || doc.province === p;
                        const yearMatch = !y || doc.year == y;
                        // Empty Filter
                        const dataMatch = !hide || doc.has_data;

                        return textMatch && provMatch && yearMatch && dataMatch;
                    });
                },

                selectDoc(doc) {
                    this.selected = doc;
                    if (this.selected.has_data) {
                        this.tab = 'analysis';
                    } else {
                        this.tab = 'text';
                    }
                }
            }))
        })
    </script>
</body>

</html>