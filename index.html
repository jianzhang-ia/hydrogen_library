<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydrogen Policy Library</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] {
            display: none !important;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body class="bg-gray-100 h-screen flex flex-col overflow-hidden" x-data="library()">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-6 py-3 flex justify-between items-center shadow-sm z-10">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">H2</div>
            <h1 class="font-semibold text-gray-800 text-lg">Hydrogen Policy Library</h1>
        </div>
        <div class="text-sm text-gray-500">
            <span x-text="filteredPolicies.length"></span> Documents Found
        </div>
    </header>

    <!-- Main Content (Mailbox Layout) -->
    <div class="flex-1 flex overflow-hidden">

        <!-- SIDEBAR: List & Search -->
        <div class="w-1/3 min-w-[350px] max-w-[500px] bg-white border-r border-gray-200 flex flex-col z-0">
            <!-- Search & Filter -->
            <div class="p-4 border-b border-gray-100 space-y-3 bg-gray-50">
                <input type="text" x-model="search" placeholder="Search titles or content..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                <div class="flex gap-2">
                    <select x-model="filterProv"
                        class="flex-1 px-3 py-1.5 bg-white border border-gray-300 rounded text-sm text-gray-600">
                        <option value="">All Provinces</option>
                        <template x-for="p in meta.provinces">
                            <option :value="p" x-text="p"></option>
                        </template>
                    </select>
                    <select x-model="filterCity" :disabled="!filterProv || availableCities.length === 0"
                        :class="(!filterProv || availableCities.length === 0) ? 'opacity-50 cursor-not-allowed' : ''"
                        class="flex-1 px-3 py-1.5 bg-white border border-gray-300 rounded text-sm text-gray-600">
                        <option value="">All Cities</option>
                        <template x-for="c in availableCities">
                            <option :value="c" x-text="c"></option>
                        </template>
                    </select>
                </div>
                <!-- Filter Checkboxes -->
                <div class="space-y-2 mt-2">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="hideEmpty" x-model="hideEmpty"
                            class="rounded text-blue-600 focus:ring-blue-500">
                        <label for="hideEmpty" class="text-xs text-gray-600 cursor-pointer select-none">Show only
                            entries with AI analysis</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="hasSubsidies" x-model="hasSubsidies"
                            class="rounded text-emerald-600 focus:ring-emerald-500">
                        <label for="hasSubsidies" class="text-xs text-gray-600 cursor-pointer select-none">Has Fiscal
                            Subsidies</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="hasTargets" x-model="hasTargets"
                            class="rounded text-blue-600 focus:ring-blue-500">
                        <label for="hasTargets" class="text-xs text-gray-600 cursor-pointer select-none">Has Development
                            Targets</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="hasTax" x-model="hasTax"
                            class="rounded text-purple-600 focus:ring-purple-500">
                        <label for="hasTax" class="text-xs text-gray-600 cursor-pointer select-none">Has Tax &
                            Finance</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="hasOther" x-model="hasOther"
                            class="rounded text-indigo-600 focus:ring-indigo-500">
                        <label for="hasOther" class="text-xs text-gray-600 cursor-pointer select-none">Has Other
                            Instruments</label>
                    </div>
                </div>
            </div>

            <!-- List -->
            <div class="flex-1 overflow-y-auto p-2 space-y-2">
                <template x-for="doc in filteredPolicies" :key="doc.id">
                    <div @click="selectDoc(doc)"
                        :class="selected && selected.id === doc.id ? 'bg-blue-50 border-blue-200 ring-1 ring-blue-300' : 'bg-white border-gray-100 hover:bg-gray-50 hover:border-gray-300'"
                        class="p-4 rounded-lg border cursor-pointer transition-all duration-200 shadow-sm">
                        <div class="flex justify-between items-start mb-1">
                            <span
                                class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600 truncate max-w-[120px]"
                                x-text="doc.province"></span>
                            <span class="text-xs text-gray-400" x-text="doc.city || doc.province"></span>
                        </div>
                        <h3 class="text-sm font-semibold text-gray-900 leading-tight mb-2" x-text="doc.title"></h3>
                        <!-- Tags -->
                        <div class="flex flex-wrap gap-1">
                            <template x-for="tag in doc.instrument_tags.slice(0, 3)">
                                <span class="text-[10px] px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded"
                                    x-text="formatTag(tag)"></span>
                            </template>
                        </div>
                    </div>
                </template>
                <div x-show="filteredPolicies.length === 0" class="p-8 text-center text-gray-400 text-sm">
                    No documents match your search.
                </div>
            </div>
        </div>

        <!-- MAIN: Detail Reader -->
        <main class="flex-1 bg-gray-50 flex flex-col relative">
            <template x-if="!selected">
                <div class="flex-1 flex flex-col items-center justify-center text-gray-400">
                    <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z">
                        </path>
                    </svg>
                    <p class="text-lg font-medium">Select a policy to analyze</p>
                </div>
            </template>

            <template x-if="selected">
                <div class="flex-1 flex flex-col h-full">
                    <!-- Detail Header -->
                    <div class="bg-white border-b border-gray-200 p-6">
                        <div class="flex items-center gap-3 text-sm text-gray-500 mb-2">
                            <span class="font-mono bg-gray-100 px-2 py-1 rounded" x-text="selected.id"></span>
                            <span>&bull;</span>
                            <span x-text="selected.province"></span>
                            <span>&bull;</span>
                            <span x-text="selected.year || 'Year Unknown'"></span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900 leading-snug" x-text="selected.title"></h2>
                    </div>

                    <!-- Tabs -->
                    <div class="flex border-b border-gray-200 bg-white px-6">
                        <button @click="tab = 'analysis'"
                            :class="tab === 'analysis' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="px-4 py-3 text-sm font-medium border-b-2 transition-colors">Analysis &
                            Insights</button>
                        <button @click="tab = 'text'"
                            :class="tab === 'text' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                            class="px-4 py-3 text-sm font-medium border-b-2 transition-colors">Full Text
                            Content</button>
                    </div>

                    <!-- Content Area -->
                    <div class="flex-1 overflow-y-auto p-8 custom-scroller">

                        <!-- VIEW: Analysis -->
                        <div x-show="tab === 'analysis'" class="space-y-6 max-w-4xl mx-auto">

                            <!-- No Data State -->
                            <div x-show="!selected.has_data"
                                class="bg-yellow-50 border border-yellow-200 text-yellow-800 p-4 rounded-lg flex items-start gap-3">
                                <svg class="w-5 h-5 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <p class="font-semibold">No Specific Economic Data Found</p>
                                    <p class="text-sm mt-1">The AI analysis did not identify specific targets,
                                        subsidies, or tax incentives in this document.</p>
                                </div>
                            </div>

                            <!-- Analysis Sections with Clean White Cards -->
                            <div x-show="selected.has_data" class="space-y-6">

                                <!-- Development Goals -->
                                <div x-show="selected.analysis.targets && selected.analysis.targets.length > 0"
                                    class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                    <h3 class="text-blue-600 font-semibold mb-5 flex items-center gap-2 text-base">
                                        <span>üéØ</span> Development Goals & Targets
                                    </h3>
                                    <div class="space-y-6">
                                        <template x-for="t in selected.analysis.targets">
                                            <div class="border-l-4 border-blue-500 pl-4 bg-blue-50/30 py-3 rounded-r">
                                                <div class="flex items-center gap-2 mb-3">
                                                    <span class="text-gray-900 font-bold text-base"
                                                        x-text="t.timeline"></span>
                                                    <span x-show="t.is_period"
                                                        class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded font-medium">Period</span>
                                                </div>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                                    <template x-for="item in t.items">
                                                        <div
                                                            class="bg-white rounded-lg p-4 border border-gray-200 shadow-sm">
                                                            <div class="text-xs text-blue-600 uppercase mb-1.5 font-semibold tracking-wide"
                                                                x-text="item.topic"></div>
                                                            <div class="flex items-baseline gap-2 mb-2">
                                                                <span class="text-gray-900 font-bold text-xl"
                                                                    x-text="item.value"></span>
                                                                <span class="text-blue-600 text-sm font-medium"
                                                                    x-text="item.unit"></span>
                                                            </div>
                                                            <div class="text-sm text-gray-700 leading-relaxed"
                                                                x-text="item.description"></div>
                                                        </div>
                                                    </template>
                                                </div>
                                                <div
                                                    class="text-xs text-gray-500 italic pl-3 border-l-2 border-gray-300 leading-relaxed">
                                                    "<span x-text="t.evidence_quote"></span>"
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- Fiscal Subsidies -->
                                <div x-show="selected.analysis.subsidies && selected.analysis.subsidies.length > 0"
                                    class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                    <h3 class="text-emerald-600 font-semibold mb-5 flex items-center gap-2 text-base">
                                        <span>üí∞</span> Fiscal Subsidies & Support
                                    </h3>
                                    <div class="space-y-3">
                                        <template x-for="sub in selected.analysis.subsidies">
                                            <div
                                                class="bg-emerald-50/40 rounded-lg p-4 border border-emerald-200 hover:bg-emerald-50 transition-colors">
                                                <div class="flex flex-col gap-3">
                                                    <!-- Type Badge -->
                                                    <div>
                                                        <span
                                                            class="inline-block px-2.5 py-1 rounded text-xs font-bold uppercase bg-emerald-100 text-emerald-700 border border-emerald-300"
                                                            x-text="sub.type"></span>
                                                    </div>
                                                    <!-- Main Content Grid -->
                                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                                        <!-- Item -->
                                                        <div class="md:col-span-1">
                                                            <div
                                                                class="text-xs text-emerald-600 font-semibold mb-1 uppercase">
                                                                Item</div>
                                                            <div class="font-bold text-gray-900 text-sm break-words"
                                                                x-text="sub.item"></div>
                                                        </div>
                                                        <!-- Standard -->
                                                        <div class="md:col-span-1">
                                                            <div
                                                                class="text-xs text-emerald-600 font-semibold mb-1 uppercase">
                                                                Standard</div>
                                                            <div class="text-blue-700 font-mono text-sm font-medium break-words"
                                                                x-text="sub.standard"></div>
                                                        </div>
                                                        <!-- Conditions -->
                                                        <div class="md:col-span-1">
                                                            <div
                                                                class="text-xs text-emerald-600 font-semibold mb-1 uppercase">
                                                                Conditions</div>
                                                            <div class="text-gray-700 text-xs leading-relaxed break-words"
                                                                x-text="sub.conditions || '-'"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- Tax & Finance -->
                                <div x-show="Object.keys(selected.analysis.taxes).length > 0"
                                    class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                    <h3 class="text-purple-600 font-semibold mb-5 flex items-center gap-2 text-base">
                                        <span>üè¶</span> Tax & Finance Policies
                                    </h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <template x-for="(val, key) in selected.analysis.taxes">
                                            <div x-show="val && val.value"
                                                class="bg-purple-50/40 rounded-lg p-4 border border-purple-200">
                                                <div class="text-sm font-bold text-purple-700 mb-2 capitalize"
                                                    x-text="key.replace('tax_', '').replace(/_/g, ' ')"></div>
                                                <div class="text-sm text-gray-800 mb-3 leading-relaxed"
                                                    x-text="val.value"></div>
                                                <div x-show="val.evidence"
                                                    class="text-xs text-gray-500 italic border-l-2 border-purple-300 pl-3 mt-2 leading-relaxed">
                                                    "<span x-text="val.evidence"></span>"
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- Other Policy Instruments -->
                                <div x-show="selected.analysis.other && selected.analysis.other.length > 0"
                                    class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                    <h3 class="text-indigo-600 font-semibold mb-5 flex items-center gap-2 text-base">
                                        <span>üîß</span> Other Policy Instruments
                                    </h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <template x-for="inst in selected.analysis.other">
                                            <div class="bg-indigo-50/40 rounded-lg p-4 border border-indigo-200">
                                                <div class="text-sm font-bold text-indigo-700 mb-2" x-text="inst.name">
                                                </div>
                                                <div class="text-sm text-gray-800 mb-3 leading-relaxed"
                                                    x-text="inst.details"></div>
                                                <div x-show="inst.evidence"
                                                    class="text-xs text-gray-500 italic border-l-2 border-indigo-300 pl-3 mt-2 leading-relaxed">
                                                    "<span x-text="inst.evidence"></span>"
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- VIEW: Full Text -->
                        <div x-show="tab === 'text'"
                            class="max-w-4xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 p-8 min-h-[500px]">
                            <div class="prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap font-serif leading-relaxed"
                                x-text="selected.content"></div>
                        </div>

                    </div>
                </div>
            </template>
        </main>
    </div>

    <!-- Script -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('library', () => ({
                policies: [],
                filteredPolicies: [],
                meta: { provinces: [], provinceCities: {}, years: [] },
                search: '',
                filterProv: '',
                filterCity: '',
                hideEmpty: true,
                hasSubsidies: false,
                hasTargets: false,
                hasTax: false,
                hasOther: false,
                selected: null,
                tab: 'analysis', // 'analysis' or 'text'

                // Computed: Available cities based on selected province
                get availableCities() {
                    if (!this.filterProv || !this.meta.provinceCities) return [];
                    return this.meta.provinceCities[this.filterProv] || [];
                },

                async init() {
                    try {
                        const res = await fetch('data/data.json');
                        const data = await res.json();
                        this.policies = data.policies;
                        this.meta = data.meta;
                        this.updateFilter();
                    } catch (e) {
                        alert("Failed to load data. Ensure server is running.");
                    }

                    this.$watch('search', () => this.updateFilter());
                    this.$watch('filterProv', () => {
                        // Reset city filter when province changes
                        this.filterCity = '';
                        this.updateFilter();
                    });
                    this.$watch('filterCity', () => this.updateFilter());
                    this.$watch('hideEmpty', () => this.updateFilter());
                    this.$watch('hasSubsidies', () => this.updateFilter());
                    this.$watch('hasTargets', () => this.updateFilter());
                    this.$watch('hasTax', () => this.updateFilter());
                    this.$watch('hasOther', () => this.updateFilter());
                },

                updateFilter() {
                    const q = this.search.toLowerCase();
                    const p = this.filterProv;
                    const c = this.filterCity;
                    const hide = this.hideEmpty;

                    this.filteredPolicies = this.policies.filter(doc => {
                        // Text Search
                        const textMatch = !q || doc.title.toLowerCase().includes(q) || (doc.content && doc.content.toLowerCase().includes(q));
                        // Filters
                        const provMatch = !p || doc.province === p;
                        const cityMatch = !c || doc.city === c;
                        // Empty Filter (has AI analysis)
                        const dataMatch = !hide || doc.has_data;
                        // Subsidies Filter
                        const subsidiesMatch = !this.hasSubsidies || (doc.analysis && doc.analysis.subsidies && doc.analysis.subsidies.length > 0);
                        // Targets Filter
                        const targetsMatch = !this.hasTargets || (doc.analysis && doc.analysis.targets && doc.analysis.targets.length > 0);
                        // Tax Filter
                        const taxMatch = !this.hasTax || (doc.analysis && doc.analysis.taxes && Object.keys(doc.analysis.taxes).length > 0);
                        // Other Instruments Filter
                        const otherMatch = !this.hasOther || (doc.analysis && doc.analysis.other && doc.analysis.other.length > 0);

                        return textMatch && provMatch && cityMatch && dataMatch && subsidiesMatch && targetsMatch && taxMatch && otherMatch;
                    });
                },

                selectDoc(doc) {
                    this.selected = doc;
                    if (this.selected.has_data) {
                        this.tab = 'analysis';
                    } else {
                        this.tab = 'text';
                    }
                },

                formatTag(tag) {
                    // Convert underscore-separated tags to readable labels
                    const tagLabels = {
                        'construction_subsidy': 'Construction',
                        'operation_subsidy': 'Operations',
                        'purchase_subsidy': 'Purchase',
                        'production_subsidy': 'Production',
                        'rd_subsidy': 'R&D',
                        'other_subsidy': 'Other Subsidy',
                        'finance_support': 'Finance',
                        'investment_funds': 'Investment',
                        'tax_breaks': 'Tax Breaks'
                    };
                    return tagLabels[tag] || tag.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                }
            }))
        })
    </script>
</body>

</html>